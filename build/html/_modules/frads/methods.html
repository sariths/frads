<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2021.04.11.beta34"/>
        <title>frads.methods - frads</title>
      <link rel="stylesheet" href="../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css" />
    <link rel="stylesheet" href="../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">frads</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">frads</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../commandline.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library.html">frads library</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <h1>Source code for frads.methods</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">Typical Radiance matrix-based simulation workflows</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">tempfile</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">geom</span>
<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">sky</span>
<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">matrix</span>

<span class="c1"># from frads import ncp</span>
<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">mtxmult</span>
<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">parsers</span>
<span class="kn">from</span> <span class="nn">frads</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">Primitive</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">Receiver</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">MradModel</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">MradPath</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">WeaMetaData</span>
<span class="kn">from</span> <span class="nn">frads.types</span> <span class="kn">import</span> <span class="n">WeaDataRow</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"frads.methods"</span><span class="p">)</span>


<div class="viewcode-block" id="get_window_group"><a class="viewcode-back" href="../../api.html#frads.methods.get_window_group">[docs]</a><span class="k">def</span> <span class="nf">get_window_group</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="sd">"""Parse window groups from config."""</span>
    <span class="n">window_groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">window_normals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Vector</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">wpath</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"window_paths"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">wname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">wpath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">_window_primitives</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">unpack_primitives</span><span class="p">(</span><span class="n">wpath</span><span class="p">)</span>
        <span class="n">window_groups</span><span class="p">[</span><span class="n">wname</span><span class="p">]</span> <span class="o">=</span> <span class="n">_window_primitives</span>
        <span class="n">_normal</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_polygon</span><span class="p">(</span><span class="n">_window_primitives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real_arg</span><span class="p">)</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span>
        <span class="n">window_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_normal</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">window_groups</span><span class="p">,</span> <span class="n">window_normals</span></div>


<div class="viewcode-block" id="get_wea_data"><a class="viewcode-back" href="../../api.html#frads.methods.get_wea_data">[docs]</a><span class="k">def</span> <span class="nf">get_wea_data</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">WeaMetaData</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">WeaDataRow</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">"""Get wea data and parse into appropriate data types."""</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wea_path</span> <span class="o">:=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Site"</span><span class="p">][</span><span class="s2">"wea_path"</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Using user specified </span><span class="si">%s</span><span class="s2"> file."</span> <span class="o">%</span> <span class="n">wea_path</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">wea_path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wea_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">rdr</span><span class="p">:</span>
            <span class="n">wea_metadata</span><span class="p">,</span> <span class="n">wea_data</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_wea</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">epw_path</span> <span class="o">:=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Site"</span><span class="p">][</span><span class="s2">"epw_path"</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Converting </span><span class="si">{</span><span class="n">epw_path</span><span class="si">}</span><span class="s2"> to a .wea file"</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">epw_path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">epw_path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">rdr</span><span class="p">:</span>
            <span class="n">wea_metadata</span><span class="p">,</span> <span class="n">wea_data</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_epw</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Need either a .wea or a .epw file"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wea_metadata</span><span class="p">,</span> <span class="n">wea_data</span><span class="p">,</span> <span class="n">name</span></div>


<div class="viewcode-block" id="get_sender_grid"><a class="viewcode-back" href="../../api.html#frads.methods.get_sender_grid">[docs]</a><span class="k">def</span> <span class="nf">get_sender_grid</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">Sender</span><span class="p">]:</span>
    <span class="sd">"""Get point grid as ray senders."""</span>
    <span class="n">sender_grid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"RaySender"</span><span class="p">][</span><span class="s2">"grid_surface"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="c1"># Take the first polygon primitive</span>
        <span class="n">gprimitives</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">unpack_primitives</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
        <span class="n">surface_polygon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">prim</span> <span class="ow">in</span> <span class="n">gprimitives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prim</span><span class="o">.</span><span class="n">ptype</span> <span class="o">==</span> <span class="s2">"polygon"</span><span class="p">:</span>
                <span class="n">surface_polygon</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_polygon</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">real_arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">surface_polygon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No polygon found in </span><span class="si">{</span><span class="n">gpath</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">sensor_pts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gen_grid</span><span class="p">(</span>
            <span class="n">surface_polygon</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"RaySender"</span><span class="p">][</span><span class="s2">"grid_height"</span><span class="p">]),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"RaySender"</span><span class="p">][</span><span class="s2">"grid_spacing"</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">sender_grid</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">points_as_sender</span><span class="p">(</span>
            <span class="n">pts_list</span><span class="o">=</span><span class="n">sensor_pts</span><span class="p">,</span> <span class="n">ray_cnt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"ray_count"</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">sender_grid</span></div>


<div class="viewcode-block" id="get_sender_view"><a class="viewcode-back" href="../../api.html#frads.methods.get_sender_view">[docs]</a><span class="k">def</span> <span class="nf">get_sender_view</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">"""Get a single view as a sender.</span>
<span class="sd">    Args:</span>
<span class="sd">        config: MradConfig object"""</span>
    <span class="n">sender_view</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">Sender</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">view_dicts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view_str</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"RaySender"</span><span class="p">][</span><span class="s2">"view"</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sender_view</span><span class="p">,</span> <span class="n">view_dicts</span>
    <span class="n">vdict</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_vu</span><span class="p">(</span><span class="n">view_str</span><span class="p">)</span>
    <span class="n">view_name</span> <span class="o">=</span> <span class="s2">"view_00"</span>
    <span class="k">if</span> <span class="s2">"vf"</span> <span class="ow">in</span> <span class="n">vdict</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vdict</span><span class="p">[</span><span class="s2">"vf"</span><span class="p">])</span> <span class="k">as</span> <span class="n">rdr</span><span class="p">:</span>
            <span class="n">vdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsers</span><span class="o">.</span><span class="n">parse_vu</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
    <span class="n">view_dicts</span><span class="p">[</span><span class="n">view_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vdict</span>
    <span class="n">sender_view</span><span class="p">[</span><span class="n">view_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">view_as_sender</span><span class="p">(</span>
        <span class="n">vu_dict</span><span class="o">=</span><span class="n">vdict</span><span class="p">,</span>
        <span class="n">ray_cnt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"ray_count"</span><span class="p">]),</span>
        <span class="n">xres</span><span class="o">=</span><span class="n">vdict</span><span class="p">[</span><span class="s2">"x"</span><span class="p">],</span>
        <span class="n">yres</span><span class="o">=</span><span class="n">vdict</span><span class="p">[</span><span class="s2">"y"</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sender_view</span><span class="p">,</span> <span class="n">view_dicts</span></div>


<div class="viewcode-block" id="assemble_model"><a class="viewcode-back" href="../../api.html#frads.methods.assemble_model">[docs]</a><span class="k">def</span> <span class="nf">assemble_model</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MradModel</span><span class="p">:</span>
    <span class="sd">"""Assemble all the pieces together."""</span>
    <span class="n">material_primitives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Primitive</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"material"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">material_primitives</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">unpack_primitives</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">window_groups</span><span class="p">,</span> <span class="n">_window_normals</span> <span class="o">=</span> <span class="n">get_window_group</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">window_normals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">item</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_window_normals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_window_normals</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">sender_grid</span> <span class="o">=</span> <span class="n">get_sender_grid</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sender_view</span><span class="p">,</span> <span class="n">view_dicts</span> <span class="o">=</span> <span class="n">get_sender_view</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">rcvr_sky</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">sky_as_receiver</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"smx_basis"</span><span class="p">])</span>
    <span class="n">cfs_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">"window_cfs"</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">]:</span>
        <span class="n">cfs_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"window_cfs"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">bsdf_mat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">wname</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wname</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">window_groups</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"window_xml"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="n">black_mat</span> <span class="o">=</span> <span class="n">Primitive</span><span class="p">(</span><span class="s2">"void"</span><span class="p">,</span> <span class="s2">"plastic"</span><span class="p">,</span> <span class="s2">"black"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"5 0 0 0 0 0"</span><span class="p">)</span>
    <span class="n">glow_mat</span> <span class="o">=</span> <span class="n">Primitive</span><span class="p">(</span><span class="s2">"void"</span><span class="p">,</span> <span class="s2">"glow"</span><span class="p">,</span> <span class="s2">"glowing"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"4 1 1 1 0"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">black_mat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">material_primitives</span><span class="p">:</span>
        <span class="n">material_primitives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">black_mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">glow_mat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">material_primitives</span><span class="p">:</span>
        <span class="n">material_primitives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glow_mat</span><span class="p">)</span>
    <span class="c1"># _, material_path = tf.mkstemp(suffix="all_material")</span>
    <span class="n">material_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"all_material_</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">id_generator</span><span class="p">()</span><span class="si">}</span><span class="s2">.rad"</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">material_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="p">[</span><span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">primitive</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">primitive</span> <span class="ow">in</span> <span class="n">material_primitives</span><span class="p">]</span>
    <span class="n">black_env_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"blackened_</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">id_generator</span><span class="p">()</span><span class="si">}</span><span class="s2">.rad"</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">black_env_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">!xform -m black </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MradModel</span><span class="p">(</span>
        <span class="n">material_path</span><span class="p">,</span>
        <span class="n">window_groups</span><span class="p">,</span>
        <span class="n">window_normals</span><span class="p">,</span>
        <span class="n">sender_grid</span><span class="p">,</span>
        <span class="n">sender_view</span><span class="p">,</span>
        <span class="n">view_dicts</span><span class="p">,</span>
        <span class="n">rcvr_sky</span><span class="p">,</span>
        <span class="n">bsdf_mat</span><span class="p">,</span>
        <span class="n">cfs_path</span><span class="p">,</span>
        <span class="n">black_env_path</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="prep_2phase_pt"><a class="viewcode-back" href="../../api.html#frads.methods.prep_2phase_pt">[docs]</a><span class="k">def</span> <span class="nf">prep_2phase_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Prepare matrices two phase methods."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 2-phase sensor point matrices..."</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">env</span> <span class="o">+=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"window_paths"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"dsmx_opt"</span><span class="p">]</span>
    <span class="n">opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"overwrite"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">sender_grid</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">pdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pdsmx_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">.mtx"</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span><span class="o">.</span><span class="n">is_file</span><span class="p">())</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">rfluxmtx</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sender_grid</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">receiver_sky</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">opt</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">pdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">],</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="prep_2phase_vu"><a class="viewcode-back" href="../../api.html#frads.methods.prep_2phase_vu">[docs]</a><span class="k">def</span> <span class="nf">prep_2phase_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Generate image-based matrices if view defined."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for image-based 2-phase matrices..."</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">env</span> <span class="o">+=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"window_paths"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"dsmx_opt"</span><span class="p">]</span>
    <span class="n">opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"overwrite"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">sender_view</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_view</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">vdsmx</span><span class="p">[</span><span class="n">view_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vdsmx_</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vdsmx</span><span class="p">[</span><span class="n">view_name</span><span class="p">]</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">view_name</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rfluxmtx</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sender_view</span><span class="p">,</span>
                <span class="n">receiver</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">receiver_sky</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">mpath</span><span class="o">.</span><span class="n">vdsmx</span><span class="p">[</span><span class="n">view_name</span><span class="p">],</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="view_matrix_pt"><a class="viewcode-back" href="../../api.html#frads.methods.view_matrix_pt">[docs]</a><span class="k">def</span> <span class="nf">view_matrix_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">_opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_opt"</span><span class="p">]</span>
    <span class="n">_env</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing direct view matrix for sensor grid:"</span><span class="p">)</span>
        <span class="n">_opt</span> <span class="o">+=</span> <span class="s2">" -ab 1"</span>
        <span class="n">_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">black_env_path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing view matrix for sensor grid:"</span><span class="p">)</span>
    <span class="n">receiver_windows</span> <span class="o">=</span> <span class="n">Receiver</span><span class="p">(</span><span class="n">receiver</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_basis"</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">sender_grid</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">wname</span><span class="p">,</span> <span class="n">window_prim</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">grid_name</span> <span class="o">+</span> <span class="n">wname</span>
            <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">pvmxd</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pvmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">_d.mtx"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pvmxd</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">pvmx</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pvmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">.mtx"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pvmx</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="n">receiver_windows</span> <span class="o">+=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">surface_as_receiver</span><span class="p">(</span>
                <span class="n">prim_list</span><span class="o">=</span><span class="n">window_prim</span><span class="p">,</span>
                <span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_basis"</span><span class="p">],</span>
                <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">"glow"</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="n">files_exist</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pvmxd</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_exist</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pvmx</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">files_exist</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span>
            <span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"overwrite"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating vmx for </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rfluxmtx</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sender_grid</span><span class="p">,</span>
                <span class="n">receiver</span><span class="o">=</span><span class="n">receiver_windows</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">_env</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">_opt</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="view_matrix_vu"><a class="viewcode-back" href="../../api.html#frads.methods.view_matrix_vu">[docs]</a><span class="k">def</span> <span class="nf">view_matrix_vu</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">"""Prepare matrices using three-phase methods."""</span>
    <span class="n">_opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_opt"</span><span class="p">]</span>
    <span class="n">_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">direct_msg</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
        <span class="n">_opt</span> <span class="o">+=</span> <span class="s2">" -i -ab 1"</span>
        <span class="n">_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">black_env_path</span><span class="p">]</span>
        <span class="n">direct_msg</span> <span class="o">=</span> <span class="s2">" direct-only"</span>
    <span class="n">_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"overwrite"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">view</span><span class="p">,</span> <span class="n">sender_view</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_view</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vrcvr_windows</span> <span class="o">=</span> <span class="n">Receiver</span><span class="p">(</span><span class="n">receiver</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_basis"</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">wname</span><span class="p">,</span> <span class="n">window_prim</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">view</span> <span class="o">+</span> <span class="n">wname</span>
            <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">vvmxd</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vvmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">_d"</span><span class="p">,</span> <span class="s2">"</span><span class="si">%04d</span><span class="s2">.hdr"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vvmxd</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">vvmx</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vvmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="si">%04d</span><span class="s2">.hdr"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vvmx</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">vrcvr_windows</span> <span class="o">+=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">surface_as_receiver</span><span class="p">(</span>
                <span class="n">prim_list</span><span class="o">=</span><span class="n">window_prim</span><span class="p">,</span>
                <span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_basis"</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">"glow"</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">any</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vvmxd</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"vvmx*_d"</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">any</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vvmx</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"vvmx*[!_d]"</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">exists</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Computing</span><span class="si">{</span><span class="n">direct_msg</span><span class="si">}</span><span class="s2"> image-based view matrix"</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rfluxmtx</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sender_view</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">vrcvr_windows</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">_env</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">_opt</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span></div>


<span class="c1"># def facade_matrix(mpath: MradPath, model: MradModel, config: ConfigParser, direct=False) -&gt; None:</span>
<span class="c1">#     """Generate facade matrices.</span>
<span class="c1">#     Args:</span>
<span class="c1">#         model (namedtuple): model assembly</span>
<span class="c1">#         config (namedtuple): model configuration</span>
<span class="c1">#     Returns:</span>
<span class="c1">#         facade matrices file path</span>
<span class="c1">#     """</span>
<span class="c1">#</span>
<span class="c1">#     logger.info("Computing facade matrix...")</span>
<span class="c1">#     fmxs = {}</span>
<span class="c1">#     fmx_opt = config["SimControl"]["fmx_opt"]</span>
<span class="c1">#     fmx_opt += f' -n {config["SimControl"]["nprocess"]}'</span>
<span class="c1">#     _env = [model.material_path] + config["Model"]["scene"].split()</span>
<span class="c1">#     overwrite = config.getboolean("SimControl", "overwrite", fallback=False)</span>
<span class="c1">#     if direct:</span>
<span class="c1">#         fmx_opt += " -ab 0"</span>
<span class="c1">#         _env = [model.material_path, model.black_env_path]</span>
<span class="c1">#     ncp_prims = {}</span>
<span class="c1">#     for ncppath in config["Model"]["ncppath"].split():</span>
<span class="c1">#         name: str = Path(ncppath).stem</span>
<span class="c1">#         ncp_prims[name] = utils.unpack_primitives(ncppath)</span>
<span class="c1">#     all_ncp_prims = [prim for _, prim in ncp_prims.items()]</span>
<span class="c1">#     all_window_prims = [prim for key, prim in model.window_groups.items()]</span>
<span class="c1">#     port_prims = ncp.gen_port_prims_from_window_ncp(all_window_prims, all_ncp_prims)</span>
<span class="c1">#     port_rcvr = matrix.surface_as_receiver(</span>
<span class="c1">#         prim_list=port_prims, basis=config["SimControl"]["fmx_basis"], out=None</span>
<span class="c1">#     )</span>
<span class="c1">#     for wname in model.window_groups:</span>
<span class="c1">#         _name = wname + "_d" if direct else wname</span>
<span class="c1">#         fmxs[wname] = Path("Matrices", f"fmx_{_name}.mtx")</span>
<span class="c1">#         window_prim = model.window_groups[wname]</span>
<span class="c1">#         sndr_window = matrix.Sender.as_surface(</span>
<span class="c1">#             prim_list=window_prim, basis=config["SimControl"]["fmx_basis"]</span>
<span class="c1">#         )</span>
<span class="c1">#         if (not fmxs[wname].is_file()) or overwrite:</span>
<span class="c1">#             logger.info("Generating facade matrix for %s", _name)</span>
<span class="c1">#             fmx_res = matrix.rfluxmtx(</span>
<span class="c1">#                 sender=sndr_window, receiver=port_rcvr, env=_env, out=None, opt=fmx_opt</span>
<span class="c1">#             )</span>
<span class="c1">#             with open(fmxs[wname], "wb") as wtr:</span>
<span class="c1">#                 wtr.write(fmx_res)</span>
<span class="c1">#     return fmxs</span>


<div class="viewcode-block" id="daylight_matrix"><a class="viewcode-back" href="../../api.html#frads.methods.daylight_matrix">[docs]</a><span class="k">def</span> <span class="nf">daylight_matrix</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Call rfluxmtx to generate daylight matrices for each sender surface."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing daylight matrix..."</span><span class="p">)</span>
    <span class="n">dmx_opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"dmx_opt"</span><span class="p">]</span>
    <span class="n">dmx_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">dmx_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
        <span class="n">dmx_opt</span> <span class="o">+=</span> <span class="s2">" -ab 0"</span>
        <span class="n">dmx_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">black_env_path</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sname</span><span class="p">,</span> <span class="n">surface_primitives</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">sname</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">dmxd</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"dmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">_d.mtx"</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">dmxd</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"dmx_</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">.mtx"</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span>
        <span class="n">sndr_window</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">surface_as_sender</span><span class="p">(</span>
            <span class="n">prim_list</span><span class="o">=</span><span class="n">surface_primitives</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"vmx_basis"</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating daylight matrix for </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">_name</span><span class="p">)</span>
            <span class="n">dmx_res</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">rfluxmtx</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sndr_window</span><span class="p">,</span>
                <span class="n">receiver</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">receiver_sky</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">dmx_env</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">dmx_opt</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dmx_res</span><span class="p">)</span></div>


<div class="viewcode-block" id="blacken_env"><a class="viewcode-back" href="../../api.html#frads.methods.blacken_env">[docs]</a><span class="k">def</span> <span class="nf">blacken_env</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">"""."""</span>
    <span class="n">bwindow_path</span> <span class="o">=</span> <span class="s2">"blackened_window.rad"</span>
    <span class="n">gwindow_path</span> <span class="o">=</span> <span class="s2">"glowing_window.rad"</span>
    <span class="n">blackened_window</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">glowing_window</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">windows</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">blackened_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Primitive</span><span class="p">(</span>
                    <span class="s2">"black"</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">ptype</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">str_arg</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">real_arg</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">glowing_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Primitive</span><span class="p">(</span>
                    <span class="s2">"glowing"</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">ptype</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">str_arg</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">real_arg</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bwindow_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">blackened_window</span><span class="p">))))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gwindow_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">glowing_window</span><span class="p">))))</span>
    <span class="n">vmap_oct</span> <span class="o">=</span> <span class="s2">"vmap.oct"</span>
    <span class="n">cdmap_oct</span> <span class="o">=</span> <span class="s2">"cdmap.oct"</span>
    <span class="n">vmap_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">"oconv"</span><span class="p">,</span> <span class="s2">"-f"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">gwindow_path</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vmap_oct</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">vmap_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">wtr</span><span class="p">)</span>
    <span class="n">cdmap_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">"oconv"</span><span class="p">,</span> <span class="s2">"-f"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"scene"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">bwindow_path</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cdmap_oct</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cdmap_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">wtr</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bwindow_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gwindow_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vmap_oct</span><span class="p">,</span> <span class="n">cdmap_oct</span></div>


<div class="viewcode-block" id="calc_4phase_pt"><a class="viewcode-back" href="../../api.html#frads.methods.calc_4phase_pt">[docs]</a><span class="k">def</span> <span class="nf">calc_4phase_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">vmx</span><span class="p">,</span> <span class="n">fmx</span><span class="p">,</span> <span class="n">dmx</span><span class="p">,</span> <span class="n">smx</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span>
<span class="p">):</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 4-phase sensor grid results"</span><span class="p">)</span>
    <span class="n">presl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">td</span><span class="p">:</span>
        <span class="n">fdmx_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="s2">"fdmx.mtx"</span><span class="p">)</span>
        <span class="n">fdmx_res</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span><span class="n">fmx</span><span class="p">,</span> <span class="n">dmx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fdmx_path</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fdmx_res</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span>
                <span class="n">vmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span> <span class="n">fmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span> <span class="n">dmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span> <span class="n">smx</span>
            <span class="p">)</span>
            <span class="n">presl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_res</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">presl</span><span class="p">)]</span>
        <span class="n">respath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="s2">"points3ph.txt"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">respath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">","</span><span class="p">)</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></div>


<span class="c1"># def prep_4phase_pt(mpath, model, config: ConfigParser, direct=False) -&gt; None:</span>
<span class="c1">#     """Prepare matrices using four-phase methods for point-based calculation."""</span>
<span class="c1">#     dmxs = {}</span>
<span class="c1">#     fmxs = {}</span>
<span class="c1">#     _opt = config["SimControl"]["fmx_opt"]</span>
<span class="c1">#     _env = [model.material_path] + config["Model"]["scene"].split()</span>
<span class="c1">#     if direct:</span>
<span class="c1">#         # need to add ncp path</span>
<span class="c1">#         _env = [model.material_path, model.black_env_path]</span>
<span class="c1">#         _opt += " -ab 0"</span>
<span class="c1">#     ncp_prims = None</span>
<span class="c1">#     for wname in model.window_groups:</span>
<span class="c1">#         window_prim = model.window_groups[wname]</span>
<span class="c1">#         _name = wname</span>
<span class="c1">#         if direct:</span>
<span class="c1">#             _name += "_d"</span>
<span class="c1">#         fmxs[wname] = Path("Matrices", "fmx_{_name}.mtx")</span>
<span class="c1">#         port_prims = ncp.gen_ports_from_window_ncp(window_prim, ncp_prims)</span>
<span class="c1">#         ncp.gen_ncp_mtx(</span>
<span class="c1">#             win_polygons=window_prim["polygon"],</span>
<span class="c1">#             port_prim=port_prims,</span>
<span class="c1">#             out=fmxs[wname],</span>
<span class="c1">#             env=_env,</span>
<span class="c1">#             sbasis=config["SimControl"]["vmx_basis"],</span>
<span class="c1">#             rbasis=config["SimControl"]["fmx_basis"],</span>
<span class="c1">#             opt=_opt,</span>
<span class="c1">#             refl=False,</span>
<span class="c1">#             forw=False,</span>
<span class="c1">#             wrap=False,</span>
<span class="c1">#         )</span>
<span class="c1">#         logger.info(f"Generating daylight matrix for {wname}")</span>
<span class="c1">#         dmxs[wname] = Path("Matrices", f"dmx_{wname}.mtx")</span>
<span class="c1">#         sndr_port = matrix.Sender.as_surface(</span>
<span class="c1">#             prim_list=port_prims, basis=config["SimControl"]["fmx_basis"], offset=None</span>
<span class="c1">#         )</span>
<span class="c1">#         matrix.rfluxmtx(</span>
<span class="c1">#             sender=sndr_port,</span>
<span class="c1">#             receiver=model.receiver_sky,</span>
<span class="c1">#             env=_env,</span>
<span class="c1">#             out=dmxs[wname],</span>
<span class="c1">#             opt=config["SimControl"]["dmx_opt"],</span>
<span class="c1">#         )</span>


<div class="viewcode-block" id="direct_sun_matrix_pt"><a class="viewcode-back" href="../../api.html#frads.methods.direct_sun_matrix_pt">[docs]</a><span class="k">def</span> <span class="nf">direct_sun_matrix_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Compute direct sun matrix for sensor points.</span>
<span class="sd">    Args:</span>
<span class="sd">        smx_path: path to sun only sky matrix</span>
<span class="sd">    Returns:</span>
<span class="sd">        path to resulting direct sun matrix</span>
<span class="sd">    """</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Direct sun matrix for sensor grid"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">sender_grid</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">pcdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pcdsmx_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">.mtx"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">pcdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">],</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating using rcontrib..."</span><span class="p">)</span>
            <span class="n">rcvr_sun</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">sun_as_receiver</span><span class="p">(</span>
                <span class="n">basis</span><span class="o">=</span><span class="s2">"r6"</span><span class="p">,</span>
                <span class="n">smx_path</span><span class="o">=</span><span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
                <span class="n">window_normals</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">window_normals</span><span class="p">,</span>
                <span class="n">full_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cdsmx_opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"cdsmx_opt"</span><span class="p">]</span>
            <span class="n">cdsmx_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
            <span class="n">cdsenv</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">black_env_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">cfs_paths</span><span class="p">]</span>
            <span class="n">sun_oct</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"sun.oct"</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rcvr_oct</span><span class="p">(</span><span class="n">rcvr_sun</span><span class="p">,</span> <span class="n">cdsenv</span><span class="p">,</span> <span class="n">sun_oct</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rcontrib</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sender_grid</span><span class="p">,</span>
                <span class="n">modifier</span><span class="o">=</span><span class="n">rcvr_sun</span><span class="o">.</span><span class="n">modifier</span><span class="p">,</span>
                <span class="n">octree</span><span class="o">=</span><span class="n">sun_oct</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">mpath</span><span class="o">.</span><span class="n">pcdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">],</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">cdsmx_opt</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sun_oct</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="direct_sun_matrix_vu"><a class="viewcode-back" href="../../api.html#frads.methods.direct_sun_matrix_vu">[docs]</a><span class="k">def</span> <span class="nf">direct_sun_matrix_vu</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">vmap_oct</span><span class="p">,</span> <span class="n">cdmap_oct</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Compute direct sun matrix for images.</span>
<span class="sd">    Args:</span>
<span class="sd">        mpath:</span>
<span class="sd">        model:</span>
<span class="sd">        vmap_oct:</span>
<span class="sd">        cdmap_oct:</span>
<span class="sd">        config:</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    """</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Direct sun matrix for view (image)"</span><span class="p">)</span>
    <span class="n">rcvr_sun</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">sun_as_receiver</span><span class="p">(</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">"r6"</span><span class="p">,</span> <span class="n">smx_path</span><span class="o">=</span><span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun_img</span><span class="p">,</span> <span class="n">window_normals</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">window_normals</span>
    <span class="p">)</span>
    <span class="n">mod_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"</span><span class="si">%04d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rcvr_sun</span><span class="o">.</span><span class="n">modifier</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">sun_oct</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"sun.oct"</span><span class="p">)</span>
    <span class="n">cdsenv</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">material_path</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">black_env_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">cfs_paths</span><span class="p">]</span>
    <span class="n">matrix</span><span class="o">.</span><span class="n">rcvr_oct</span><span class="p">(</span><span class="n">rcvr_sun</span><span class="p">,</span> <span class="n">cdsenv</span><span class="p">,</span> <span class="n">sun_oct</span><span class="p">)</span>
    <span class="n">cdsmx_opt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"cdsmx_opt"</span><span class="p">]</span>
    <span class="n">cdsmx_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' -n </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"nprocess"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
    <span class="k">for</span> <span class="n">view</span><span class="p">,</span> <span class="n">sndr</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_view</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vmap_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">.hdr"</span><span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">cdmap</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"cdmap_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">.hdr"</span><span class="p">)</span>
        <span class="n">vdict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">view</span><span class="p">]</span>
        <span class="n">vdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"pj"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">view_str</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">opt2str</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"rpict"</span><span class="p">]</span> <span class="o">+</span> <span class="n">view_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"-ps"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"-ab"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-av"</span><span class="p">,</span> <span class="s2">".31831"</span><span class="p">,</span> <span class="s2">".31831"</span><span class="p">,</span> <span class="s2">".31831"</span><span class="p">]</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vmap_oct</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">view</span><span class="p">],</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">wtr</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdmap_oct</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">cdmap</span><span class="p">[</span><span class="n">view</span><span class="p">],</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">wtr</span><span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">vcdfmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vcdfmx_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">vcdrmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"vcdrmx_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">tempf</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="s2">"vcdfmx"</span><span class="p">)</span>
        <span class="n">tempr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">,</span> <span class="s2">"vcdrmx"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">vcdfmx</span><span class="p">[</span><span class="n">view</span><span class="p">],</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Generating direct sun f matrix for </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rcontrib</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sndr</span><span class="p">,</span>
                <span class="n">modifier</span><span class="o">=</span><span class="n">rcvr_sun</span><span class="o">.</span><span class="n">modifier</span><span class="p">,</span>
                <span class="n">octree</span><span class="o">=</span><span class="n">sun_oct</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">tempf</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">cdsmx_opt</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">vcdfmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tempf</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))):</span>
                <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">vcdfmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">mod_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">vcdrmx</span><span class="p">[</span><span class="n">view</span><span class="p">],</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Generating direct sun r matrix for </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">rcontrib</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">sndr</span><span class="p">,</span>
                <span class="n">modifier</span><span class="o">=</span><span class="n">rcvr_sun</span><span class="o">.</span><span class="n">modifier</span><span class="p">,</span>
                <span class="n">octree</span><span class="o">=</span><span class="n">sun_oct</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">tempr</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">cdsmx_opt</span> <span class="o">+</span> <span class="s2">" -i+"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">vcdrmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tempr</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))):</span>
                <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">vcdrmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">mod_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempr</span><span class="p">)</span>
    <span class="n">sun_oct</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="calc_2phase_pt"><a class="viewcode-back" href="../../api.html#frads.methods.calc_2phase_pt">[docs]</a><span class="k">def</span> <span class="nf">calc_2phase_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span>
    <span class="n">datetime_stamps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 2-phase sensor grid results."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grid_name</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">pdsmx</span><span class="p">:</span>
        <span class="n">grid_lines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="c1"># we don't care about the direction part</span>
        <span class="n">xypos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid_lines</span><span class="p">]</span>
        <span class="n">opath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'grid_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s1">.txt'</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">pdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">],</span> <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xypos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_2phase_vu"><a class="viewcode-back" href="../../api.html#frads.methods.calc_2phase_vu">[docs]</a><span class="k">def</span> <span class="nf">calc_2phase_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 2-phase image-based results"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vdsmx</span><span class="p">:</span>
        <span class="n">opath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'view_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opath</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">opath</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">sprun</span><span class="p">(</span>
            <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">vdsmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">/</span> <span class="s2">"</span><span class="si">%04d</span><span class="s2">.hdr"</span><span class="p">,</span> <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span> <span class="n">odir</span><span class="o">=</span><span class="n">opath</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ofiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ofiles</span><span class="p">):</span>
            <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">opath</span> <span class="o">/</span> <span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span></div>


<div class="viewcode-block" id="calc_3phase_pt"><a class="viewcode-back" href="../../api.html#frads.methods.calc_3phase_pt">[docs]</a><span class="k">def</span> <span class="nf">calc_3phase_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span>
    <span class="n">datetime_stamps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 3-phase sensor grid results"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grid_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="p">:</span>
        <span class="n">presl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grid_lines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">xyzpos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid_lines</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">wname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">pvmx</span><span class="p">[</span><span class="n">grid_name</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_res</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">presl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_res</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">presl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_res</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">presl</span><span class="p">)]</span>
        <span class="n">respath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'grid_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s1">.txt'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">respath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xyzpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_3phase_vu"><a class="viewcode-back" href="../../api.html#frads.methods.calc_3phase_vu">[docs]</a><span class="k">def</span> <span class="nf">calc_3phase_vu</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing for 3-phase image-based results:"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_view</span><span class="p">:</span>
        <span class="n">opath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'view_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opath</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">opath</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"for </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
        <span class="n">vresl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">:</span>
            <span class="n">_vrespath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">wname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">_vrespath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">vvmx</span><span class="p">[</span><span class="n">view</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
                <span class="n">odir</span><span class="o">=</span><span class="n">_vrespath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">sprun</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">vresl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_vrespath</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vresl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"+"</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vresl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mtxmult</span><span class="o">.</span><span class="n">batch_pcomb</span><span class="p">(</span>
                <span class="n">vresl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">opath</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"nprocess"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">vresl</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">vresl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opath</span><span class="p">)</span>
        <span class="n">ofiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ofile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ofiles</span><span class="p">):</span>
            <span class="n">ofile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">opath</span> <span class="o">/</span> <span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span></div>


<div class="viewcode-block" id="calc_5phase_pt"><a class="viewcode-back" href="../../api.html#frads.methods.calc_5phase_pt">[docs]</a><span class="k">def</span> <span class="nf">calc_5phase_pt</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span>
    <span class="n">datetime_stamps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""."""</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Computing sensor grid results"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grid_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="p">:</span>
        <span class="n">presl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pdresl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grid_lines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_grid</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">xyzpos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid_lines</span><span class="p">]</span>
        <span class="n">mult_cds</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">pcdsmx</span><span class="p">[</span><span class="n">grid_name</span><span class="p">],</span> <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mult_cds</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">prescd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mult_cds</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prescd</span> <span class="o">=</span> <span class="n">mult_cds</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">wname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">pvmx</span><span class="p">[</span><span class="n">grid_name</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_resd</span> <span class="o">=</span> <span class="n">mtxmult</span><span class="o">.</span><span class="n">mtxmult</span><span class="p">(</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">pvmxd</span><span class="p">[</span><span class="n">grid_name</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">dmxd</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                <span class="n">mpath</span><span class="o">.</span><span class="n">smxd</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_res</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">_res</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_res</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="n">_resd</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_resd</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_res</span> <span class="o">=</span> <span class="n">_res</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">_resd</span> <span class="o">=</span> <span class="n">_resd</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">presl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_res</span><span class="p">)</span>
            <span class="n">pdresl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_resd</span><span class="p">)</span>
        <span class="n">pres3</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">presl</span><span class="p">)]</span>
        <span class="n">pres3d</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pdresl</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pres3</span><span class="p">,</span> <span class="n">pres3d</span><span class="p">,</span> <span class="n">prescd</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">respath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'grid_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s1">.txt'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">respath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
            <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xyzpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)):</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">wtr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_5phase_vu"><a class="viewcode-back" href="../../api.html#frads.methods.calc_5phase_vu">[docs]</a><span class="k">def</span> <span class="nf">calc_5phase_vu</span><span class="p">(</span>
    <span class="n">mpath</span><span class="p">:</span> <span class="n">MradPath</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span>
    <span class="n">datetime_stamps</span><span class="p">,</span>
    <span class="n">datetime_stamps_d6</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">"""Compute for image-based 5-phase method result."""</span>
    <span class="n">nprocess</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"nprocess"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sender_view</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Computing for image-based results for </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">vresl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vdresl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">td</span><span class="p">:</span>
            <span class="n">vrescdr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="n">vrescdf</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="n">vrescd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                    <span class="n">mpath</span><span class="o">.</span><span class="n">vcdrmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">/</span> <span class="s2">"</span><span class="si">%04d</span><span class="s2">.hdr"</span><span class="p">,</span> <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun_img</span><span class="p">,</span> <span class="n">odir</span><span class="o">=</span><span class="n">vrescdr</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                    <span class="n">mpath</span><span class="o">.</span><span class="n">vcdfmx</span><span class="p">[</span><span class="n">view</span><span class="p">]</span> <span class="o">/</span> <span class="s2">"</span><span class="si">%04d</span><span class="s2">.hdr"</span><span class="p">,</span> <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun_img</span><span class="p">,</span> <span class="n">odir</span><span class="o">=</span><span class="n">vrescdf</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">wname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">:</span>
                <span class="n">_vrespath</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">)</span>
                <span class="n">_vdrespath</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">)</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">vvmx</span><span class="p">[</span><span class="n">view</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">dmx</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
                        <span class="n">odir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">_vrespath</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">mtxmult</span><span class="o">.</span><span class="n">get_imgmult_cmd</span><span class="p">(</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">vvmxd</span><span class="p">[</span><span class="n">view</span> <span class="o">+</span> <span class="n">wname</span><span class="p">],</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">bsdf_xml</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">dmxd</span><span class="p">[</span><span class="n">wname</span><span class="p">],</span>
                        <span class="n">mpath</span><span class="o">.</span><span class="n">smxd</span><span class="p">,</span>
                        <span class="n">odir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">_vdrespath</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">vresl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">_vrespath</span><span class="p">))</span>
                <span class="n">vdresl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">_vdrespath</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Multiplying matrices for images."</span><span class="p">)</span>
            <span class="c1"># i = 0</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="c1"># i += 1</span>
                <span class="c1"># proc = sp.Popen(cmd)</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># if i % nprocess == 0:</span>
                <span class="c1"># proc.wait()</span>
            <span class="c1"># proc.wait()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Combine results for each window groups."</span><span class="p">)</span>
            <span class="n">res3</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="n">res3di</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="n">res3d</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">td</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"+"</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vresl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">mtxmult</span><span class="o">.</span><span class="n">batch_pcomb</span><span class="p">(</span><span class="n">vresl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">res3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nprocess</span><span class="p">)</span>
                <span class="n">mtxmult</span><span class="o">.</span><span class="n">batch_pcomb</span><span class="p">(</span><span class="n">vdresl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">res3di</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nprocess</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">vresl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">):</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res3</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">vdresl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">):</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res3di</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Applying material reflectance map"</span><span class="p">)</span>
            <span class="n">mtxmult</span><span class="o">.</span><span class="n">batch_pcomb</span><span class="p">(</span>
                <span class="p">[</span><span class="n">res3di</span><span class="p">,</span> <span class="n">mpath</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">view</span><span class="p">]],</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">],</span> <span class="n">res3d</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nprocess</span>
            <span class="p">)</span>
            <span class="n">mtxmult</span><span class="o">.</span><span class="n">batch_pcomb</span><span class="p">(</span>
                <span class="p">[</span><span class="n">vrescdr</span><span class="p">,</span> <span class="n">mpath</span><span class="o">.</span><span class="n">cdmap</span><span class="p">[</span><span class="n">view</span><span class="p">],</span> <span class="n">vrescdf</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">"*"</span><span class="p">,</span> <span class="s2">"+"</span><span class="p">],</span>
                <span class="n">vrescd</span><span class="p">,</span>
                <span class="n">nproc</span><span class="o">=</span><span class="n">nprocess</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">opath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Results"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"view_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'Model'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opath</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">opath</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Assemble all phase results."</span><span class="p">)</span>
            <span class="n">res3_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res3</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))</span>
            <span class="p">[</span>
                <span class="n">res3_path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res3</span> <span class="o">/</span> <span class="p">(</span><span class="n">stamp</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">res3d_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res3d</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))</span>
            <span class="p">[</span>
                <span class="n">res3d_path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res3d</span> <span class="o">/</span> <span class="p">(</span><span class="n">stamp</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datetime_stamps</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">vrescd_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vrescd</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.hdr"</span><span class="p">))</span>
            <span class="p">[</span>
                <span class="n">vrescd_path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">vrescd</span> <span class="o">/</span> <span class="p">(</span><span class="n">stamp</span> <span class="o">+</span> <span class="s2">".hdr"</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datetime_stamps_d6</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">opath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hdr3</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">res3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hdr3</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">vrescd</span><span class="p">):</span>
                    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                        <span class="s2">"pcomb"</span><span class="p">,</span>
                        <span class="s2">"-o"</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">res3</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">),</span>
                        <span class="s2">"-s"</span><span class="p">,</span>
                        <span class="s2">"-1"</span><span class="p">,</span>
                        <span class="s2">"-o"</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">res3d</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">),</span>
                        <span class="s2">"-o"</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">vrescd</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">),</span>
                        <span class="n">opath</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res3</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">,</span> <span class="n">opath</span> <span class="o">/</span> <span class="n">hdr3</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ni</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                    <span class="n">ni</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wtr</span><span class="p">:</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">wtr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ni</span> <span class="o">%</span> <span class="n">nprocess</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Done computing for </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div>


<div class="viewcode-block" id="regen"><a class="viewcode-back" href="../../api.html#frads.methods.regen">[docs]</a><span class="k">def</span> <span class="nf">regen</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Decides whether to regenerate a file depending on</span>
<span class="sd">    if the file already exists and if overwrite is on.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">exist</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"overwrite"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="two_phase"><a class="viewcode-back" href="../../api.html#frads.methods.two_phase">[docs]</a><span class="k">def</span> <span class="nf">two_phase</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MradPath</span><span class="p">:</span>
    <span class="sd">"""Two-phase simulation workflow."""</span>
    <span class="n">mpath</span> <span class="o">=</span> <span class="n">MradPath</span><span class="p">()</span>
    <span class="n">wea_meta</span><span class="p">,</span> <span class="n">wea_data</span><span class="p">,</span> <span class="n">wea_name</span> <span class="o">=</span> <span class="n">get_wea_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wea_name</span> <span class="o">+</span> <span class="s2">".smx"</span><span class="p">)</span>
    <span class="n">wea_data</span><span class="p">,</span> <span class="n">datetime_stamps</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">filter_wea</span><span class="p">(</span>
        <span class="n">wea_data</span><span class="p">,</span>
        <span class="n">wea_meta</span><span class="p">,</span>
        <span class="n">daylight_hours_only</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"daylight_hours_only"</span><span class="p">),</span>
        <span class="n">start_hour</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"start_hour"</span><span class="p">),</span>
        <span class="n">end_hour</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"end_hour"</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">gendaymtx</span><span class="p">(</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"smx_basis"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">wea_data</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">wea_meta</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">prep_2phase_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">prep_2phase_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"no_multiply"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">calc_2phase_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">calc_2phase_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mpath</span></div>


<div class="viewcode-block" id="three_phase"><a class="viewcode-back" href="../../api.html#frads.methods.three_phase">[docs]</a><span class="k">def</span> <span class="nf">three_phase</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">MradModel</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MradPath</span><span class="p">:</span>
    <span class="sd">"""3/5-phase simulation workflow."""</span>
    <span class="n">mpath</span> <span class="o">=</span> <span class="n">MradPath</span><span class="p">()</span>
    <span class="n">wea_meta</span><span class="p">,</span> <span class="n">wea_data</span><span class="p">,</span> <span class="n">wea_name</span> <span class="o">=</span> <span class="n">get_wea_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wea_name</span> <span class="o">+</span> <span class="s2">".smx"</span><span class="p">)</span>
    <span class="n">wea_data</span><span class="p">,</span> <span class="n">datetime_stamps</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">filter_wea</span><span class="p">(</span>
        <span class="n">wea_data</span><span class="p">,</span>
        <span class="n">wea_meta</span><span class="p">,</span>
        <span class="n">daylight_hours_only</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"daylight_hours_only"</span><span class="p">),</span>
        <span class="n">start_hour</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"start_hour"</span><span class="p">),</span>
        <span class="n">end_hour</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">"Site"</span><span class="p">,</span> <span class="s2">"end_hour"</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">regen</span><span class="p">(</span><span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">gendaymtx</span><span class="p">(</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">smx</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"smx_basis"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">wea_data</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">wea_meta</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">view_matrix_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">view_matrix_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">daylight_matrix</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
        <span class="n">wea_data_d6</span><span class="p">,</span> <span class="n">datetime_stamps_d6</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">filter_wea</span><span class="p">(</span>
            <span class="n">wea_data</span><span class="p">,</span>
            <span class="n">wea_meta</span><span class="p">,</span>
            <span class="n">daylight_hours_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">start_hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">end_hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">remove_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">window_normals</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">window_normals</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">smxd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wea_name</span> <span class="o">+</span> <span class="s2">"_d.smx"</span><span class="p">)</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">gendaymtx</span><span class="p">(</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">smxd</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"smx_basis"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">wea_data</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">wea_meta</span><span class="p">,</span>
            <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun_img</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wea_name</span> <span class="o">+</span> <span class="s2">"_d6_img.smx"</span><span class="p">)</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">gendaymtx</span><span class="p">(</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun_img</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"cdsmx_basis"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">wea_data_d6</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">wea_meta</span><span class="p">,</span>
            <span class="n">onesun</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"Matrices"</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wea_name</span> <span class="o">+</span> <span class="s2">"_d6.smx"</span><span class="p">)</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">gendaymtx</span><span class="p">(</span>
            <span class="n">mpath</span><span class="o">.</span><span class="n">smx_sun</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"SimControl"</span><span class="p">][</span><span class="s2">"cdsmx_basis"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">wea_data</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">wea_meta</span><span class="p">,</span>
            <span class="n">onesun</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">vmap_oct</span><span class="p">,</span> <span class="n">cdmap_oct</span> <span class="o">=</span> <span class="n">blacken_env</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">direct_sun_matrix_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">direct_sun_matrix_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">vmap_oct</span><span class="p">,</span> <span class="n">cdmap_oct</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">daylight_matrix</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">view_matrix_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">view_matrix_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vmap_oct</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cdmap_oct</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"no_multiply"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">calc_5phase_pt</span><span class="p">(</span>
                <span class="n">mpath</span><span class="p">,</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">datetime_stamps</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">calc_5phase_vu</span><span class="p">(</span>
                <span class="n">mpath</span><span class="p">,</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">datetime_stamps</span><span class="p">,</span>
                <span class="n">datetime_stamps_d6</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">"SimControl"</span><span class="p">,</span> <span class="s2">"no_multiply"</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">calc_3phase_pt</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">calc_3phase_vu</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">datetime_stamps</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mpath</span></div>


<span class="c1"># def four_phase(model: MradModel, config: ConfigParser, direct=False):</span>
<span class="c1">#     """Four-phase simulation workflow."""</span>
<span class="c1">#     mpath = MradPath()</span>
<span class="c1">#     wea_meta, wea_data, wea_name = get_wea_data(config)</span>
<span class="c1">#     mpath.smx = Path("Matrices") / (wea_name + ".smx")</span>
<span class="c1">#     wea_meta, wea_data, datetime_stamps = sky.filter_wea(</span>
<span class="c1">#         wea_data,</span>
<span class="c1">#         wea_meta,</span>
<span class="c1">#         daylight_hours_only=config.getboolean("Site", "daylight_hours_only"),</span>
<span class="c1">#         start_hour=config.getfloat("Site", "start_hour"),</span>
<span class="c1">#         end_hour=config.getfloat("Site", "end_hour"),</span>
<span class="c1">#     )</span>
<span class="c1">#     if regen(mpath.smx, config):</span>
<span class="c1">#         sky.gendaymtx(</span>
<span class="c1">#             mpath.smx, config["SimControl"]["smx_basis"], data=wea_data, meta=wea_meta</span>
<span class="c1">#         )</span>
<span class="c1">#     view_matrix_pt(mpath, model, config)</span>
<span class="c1">#     view_matrix_vu(mpath, model, config)</span>
<span class="c1">#     fmxs = facade_matrix(model, config)</span>
<span class="c1">#     dmxs = daylight_matrix(model.port_prims, model, config)</span>
<span class="c1">#     if direct:</span>
<span class="c1">#         wea_path_d6, datetime_stamps_d6 = get_wea(</span>
<span class="c1">#             config, window_normals=model.window_normals</span>
<span class="c1">#         )</span>
<span class="c1">#         smxd = sky.gendaymtx(</span>
<span class="c1">#             wea_path, config["SimControl"]["smx_basis"], Path("Matrices"), direct=True</span>
<span class="c1">#         )</span>
<span class="c1">#         smx_sun_img = sky.gendaymtx(</span>
<span class="c1">#             wea_path_d6,</span>
<span class="c1">#             config["SimControl"]["cdsmx_basis"],</span>
<span class="c1">#             Path("Matrices"),</span>
<span class="c1">#             onesun=True,</span>
<span class="c1">#             direct=True,</span>
<span class="c1">#         )</span>
<span class="c1">#         smx_sun = sky.gendaymtx(</span>
<span class="c1">#             wea_path,</span>
<span class="c1">#             config["SimControl"]["cdsmx_basis"],</span>
<span class="c1">#             Path("Matrices"),</span>
<span class="c1">#             onesun=True,</span>
<span class="c1">#             direct=True,</span>
<span class="c1">#         )</span>
<span class="c1">#         vmap_oct, cdmap_oct = blacken_env(model, config)</span>
<span class="c1">#         pcdsmx = direct_sun_matrix_pt(mpath, model, smx_sun, config)</span>
<span class="c1">#         vcdfmx, vcdrmx, vmap_paths, cdmap_paths = direct_sun_matrix_vu(</span>
<span class="c1">#             mpath, model, smx_sun_img, vmap_oct, cdmap_oct, config</span>
<span class="c1">#         )</span>
<span class="c1">#         dmxsd = daylight_matrix(model.window_groups, model, config, direct=True)</span>
<span class="c1">#         pvmxsd = view_matrix_pt(mpath, model, config, direct=True)</span>
<span class="c1">#         vvmxsd = view_matrix_vu(mpath, model, config, direct=True)</span>
<span class="c1">#         calc_5phase_pt(</span>
<span class="c1">#             mpath,</span>
<span class="c1">#             model,</span>
<span class="c1">#             datetime_stamps,</span>
<span class="c1">#             config,</span>
<span class="c1">#         )</span>
<span class="c1">#         calc_5phase_vu(</span>
<span class="c1">#             mpath,</span>
<span class="c1">#             model,</span>
<span class="c1">#             datetime_stamps,</span>
<span class="c1">#             datetime_stamps_d6,</span>
<span class="c1">#             config,</span>
<span class="c1">#         )</span>
<span class="c1">#     else:</span>
<span class="c1">#         calc_4phase_pt(mpath, model, datetime_stamps, config)</span>
<span class="c1"># calc_4phase_vu(vvmxs, fmxs, dmxs, smx)</span>


<span class="c1">#     def prep_4phase_vu(self):</span>
<span class="c1">#         """."""</span>
<span class="c1">#         vvmxs = {}</span>
<span class="c1">#         dmxs = {}</span>
<span class="c1">#         fmxs = {}</span>
<span class="c1">#         prcvr_windows = matrix.Receiver(</span>
<span class="c1">#             receiver='', basis=self.vmx_basis, modifier=None)</span>
<span class="c1">#         if len(self.sndr_views) &gt; 0:</span>
<span class="c1">#             vrcvr_windows = {}</span>
<span class="c1">#             for view in model.sender_view:</span>
<span class="c1">#                 vrcvr_windows[view] = matrix.Receiver(</span>
<span class="c1">#                     receiver='', basis=self.vmx_basis, modifier=None)</span>
<span class="c1">#         port_prims = ncp.gen_ports_from_window_ncp</span>
<span class="c1">#             wpolys=window_prims, npolys=ncp_prims, depth=None, scale=None)</span>
<span class="c1">#         ncp.Genfmtx(win_polygons=window_polygon, port_prim=port_prims,</span>
<span class="c1">#                         out=kwargs['o'], env=kwargs['env'], sbasis=kwargs['ss'],</span>
<span class="c1">#                         rbasis=kwargs['rs'], opt=kwargs['opt'], refl=False,</span>
<span class="c1">#                         forw=False, wrap=False)</span>
<span class="c1">#         for wname in model.window_groups:</span>
<span class="c1">#             window_prim = model.window_groups[wname]</span>
<span class="c1">#             logger.info(f"Generating daylight matrix for {wname}")</span>
<span class="c1">#             dmxs[wname] = Path(self.mtxdir, f'dmx_{wname}.mtx')</span>
<span class="c1">#             sndr_window = matrix.Sender.as_surface(</span>
<span class="c1">#                 prim_list=window_prim, basis=self.vmx_basis, offset=None)</span>
<span class="c1">#             sndr_port = matrix.Sender.as_surface(</span>
<span class="c1">#                 prim_list=port_prims, basis=self.fmx_basis, offset=None)</span>
<span class="c1">#             matrix.rfluxmtx(sender=sndr_port, receiver=model.receiver_sky,</span>
<span class="c1">#                             env=self.envpath, out=dmxs[wname], opt=self.dmx_opt)</span>
<span class="c1">#             for view in model.sender_view:</span>
<span class="c1">#                 vvmxs[view+wname] = Path(</span>
<span class="c1">#                     self.mtxdir, f'vvmx_{view}_{wname}', '%04d.hdr')</span>
<span class="c1">#                 utils.mkdir_p(os.path.dirname(vvmxs[view+wname]))</span>
<span class="c1">#                 vrcvr_windows[view] += matrix.Receiver.as_surface(</span>
<span class="c1">#                     prim_list=window_prim, basis=self.vmx_basis,</span>
<span class="c1">#                     offset=None, left=None, source='glow', out=vvmxs[view+wname])</span>
<span class="c1">#         logger.info(f"Generating view matrix for {view}")</span>
<span class="c1">#         for view in model.sender_view:</span>
<span class="c1">#             matrix.rfluxmtx(sender=model.sender_view[view], receiver=vrcvr_windows[view],</span>
<span class="c1">#                             env=self.envpath, opt=self.vmx_opt, out=None)</span>
</pre></div>
      </article>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
              Copyright &#169; 2020, LBNL
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>