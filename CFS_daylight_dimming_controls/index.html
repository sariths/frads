
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.4">
    
    
      
        <title>How-to Guides - Complex Fenestration System(CFS) and Daylight Dimming Controls</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.9c788c91.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-control-cfs-and-lighting-in-e-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Complex Fenestration System(CFS) and Daylight Dimming Controls" class="md-header__button md-logo" aria-label="Complex Fenestration System(CFS) and Daylight Dimming Controls" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Complex Fenestration System(CFS) and Daylight Dimming Controls
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How-to Guides
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Complex Fenestration System(CFS) and Daylight Dimming Controls" class="md-nav__button md-logo" aria-label="Complex Fenestration System(CFS) and Daylight Dimming Controls" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Complex Fenestration System(CFS) and Daylight Dimming Controls
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          How-to Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        How-to Guides
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#import-required-python-libraries" class="md-nav__link">
    Import required Python libraries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-energypluse-model" class="md-nav__link">
    Load EnergyPlus(E+) model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-cfs-objects-to-e-model" class="md-nav__link">
    Add CFS objects to E+ model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-lighting-objects-to-e-model" class="md-nav__link">
    Add lighting objects to E+ model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-radiance-model" class="md-nav__link">
    Initialize Radiance model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-controller-function-for-cfs-construction-states-and-daylight-dimming" class="md-nav__link">
    Define controller function for CFS construction states and daylight dimming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-pyenergyplusapi-to-simulate" class="md-nav__link">
    Initialize pyenergyplus.api to simulate
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-and-visualize-results" class="md-nav__link">
    Load and visualize results
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#import-required-python-libraries" class="md-nav__link">
    Import required Python libraries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-energypluse-model" class="md-nav__link">
    Load EnergyPlus(E+) model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-cfs-objects-to-e-model" class="md-nav__link">
    Add CFS objects to E+ model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-lighting-objects-to-e-model" class="md-nav__link">
    Add lighting objects to E+ model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-radiance-model" class="md-nav__link">
    Initialize Radiance model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-controller-function-for-cfs-construction-states-and-daylight-dimming" class="md-nav__link">
    Define controller function for CFS construction states and daylight dimming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-pyenergyplusapi-to-simulate" class="md-nav__link">
    Initialize pyenergyplus.api to simulate
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-and-visualize-results" class="md-nav__link">
    Load and visualize results
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="how-to-control-cfs-and-lighting-in-e-model">How to control CFS and lighting in E+ Model?</h1>
<h2 id="import-required-python-libraries">Import required Python libraries</h2>
<pre><code class="language-python">import datetime
import json
import os
from pathlib import Path
import sys 

from frads import epjson2rad, eprad, parsers, matrix, methods, sky, types, window
import pandas as pd
</code></pre>
<p>Need to make sure EnergyPlus is in sys.path in order to load <code> pyenergyplus.api </code></p>
<pre><code>srcloc = {'win32': 'C:\\', 'darwin': '/Applications', 'linux': '/usr/local'}
dname  = [os.path.join(srcloc[sys.platform], d) for d in os.listdir(srcloc[sys.platform]) if d.startswith('EnergyPlus')]
ephome = dname.pop()
if ephome not in sys.path:
    sys.path.append(ephome)

from pyenergyplus.api import EnergyPlusAPI
</code></pre>
<h2 id="load-energypluse-model">Load EnergyPlus(E+) model</h2>
<p>The example idf file is from the EnergyPlus ExampleFiles directory. The building is 15.24m X 15.24m, single zone with one south-facing window.</p>
<p>Initialize an E+ model by calling <code> eprad.load_epmodel </code> with an input of idf or epjs file.</p>
<pre><code class="language-python">idf_path = Path(&quot;1ZoneUncontrolled_win_1.idf&quot;)
api = EnergyPlusAPI()
epmodel = eprad.load_epmodel(idf_path, api)
</code></pre>
<h2 id="add-cfs-objects-to-e-model">Add CFS objects to E+ model</h2>
<p>Create an unshaded glazing system, consisted of one layer of 6mm clear glass. Initialize a glazing system by calling <code> window.GlazingSystem()</code>. Then, use <code> add_glazing_layer</code>  and <code> add_shading_layer</code> respectively, to add glazing and shading layer to the glazing system. </p>
<pre><code class="language-python">gs_unshaded = window.GlazingSystem()
gs_unshaded.add_glazing_layer(&quot;products/CLEAR_6.DAT&quot;)
</code></pre>
<p>This is how you get the name of the glazing system.</p>
<pre><code class="language-python">gs_unshaded.name
</code></pre>
<pre><code>'Generic Clear Glass'
</code></pre>
<p>Create a shaded glazing system, consisted of one layer of 6mm clear glass and one layer of shading: 2011-SA1.</p>
<pre><code class="language-python">gs_shaded = window.GlazingSystem()
gs_shaded.add_glazing_layer(&quot;products/CLEAR_6.DAT&quot;)
gs_shaded.add_shading_layer(&quot;products/2011-SA1.XML&quot;)
</code></pre>
<pre><code class="language-python">gs_shaded.name
</code></pre>
<pre><code>'Generic Clear Glass_Satine 5500 5%, White Pearl'
</code></pre>
<p>After the adding glazing and shading layers to the glazing system, compute solar and the solar and photopic results using <code> compute_solar_photopic_results</code>. Need to re-compute each time when the glazing system layering composition changes.</p>
<pre><code class="language-python">gs_unshaded.compute_solar_photopic_results()
</code></pre>
<pre><code class="language-python">gs_shaded.compute_solar_photopic_results()
</code></pre>
<p>Add the unshaded and shaded glazing systems to E+ model by calling <code>add_cfs</code>.</p>
<pre><code class="language-python">epmodel.add_cfs(gs_unshaded)
epmodel.add_cfs(gs_shaded)
</code></pre>
<h2 id="add-lighting-objects-to-e-model">Add lighting objects to E+ model</h2>
<p>Use <code>add_lighting</code> to add a lighting object for each of the zones in the building.</p>
<pre><code class="language-python">epmodel.add_lighting()
</code></pre>
<p>This is a list of attributes of the EPModel class</p>
<pre><code class="language-python">epmodel.windows
</code></pre>
<pre><code>['Zn001:Wall001:Win001']
</code></pre>
<pre><code class="language-python">epmodel.cfs
</code></pre>
<pre><code>['Generic Clear Glass', 'Generic Clear Glass_Satine 5500 5%, White Pearl']
</code></pre>
<pre><code class="language-python">epmodel.lighting_zone
</code></pre>
<pre><code>['Light_ZONE ONE']
</code></pre>
<pre><code class="language-python">epmodel.zones
</code></pre>
<pre><code>['ZONE ONE']
</code></pre>
<h2 id="initialize-radiance-model">Initialize Radiance model</h2>
<p>Create a Radiance model by calling <code>epjson2rad.epjson2rad</code> and passing in an epjs and epw files. The epjs file can be accessed by calling <code>epmodel.epjs</code>. The <code>epjson2rad.epjson2rad</code> function creates an <code>Objects</code> directory for material and geometry primitives and a <code>Resources</code> directory for transmission matrices (xml files). The <code>epjson2rad.epjson2rad</code> function also generates a <code>config</code> file, which contains information about simulation controls setting, site, model, and raysender. Use <code>methods.three_phase</code> to perform the three-phase method and generate the view and daylight matrices under the <code>Matrices</code> directory. Finally, load the view, daylight, and transmission matrices with <code>load_matrix</code>.</p>
<pre><code class="language-python">zone = &quot;ZONE_ONE&quot;
floor = &quot;Zn001:Flr001&quot;
wall_wndo = &quot;Zn001:Wall001&quot;

# generate Radiance model
# generate view, daylight, and transmission matrices
epjson2rad.epjson2rad(epmodel.epjs, epw=&quot;USA_CA_Oakland.Intl.AP.724930_TMY3.epw&quot;)
cfg_file = Path(f&quot;{zone}.cfg&quot;)
config = parsers.parse_mrad_config(cfg_file)
config[&quot;SimControl&quot;][&quot;no_multiply&quot;] = &quot;true&quot;
with methods.assemble_model(config) as model:
    mpath = methods.three_phase(model, config)

# load matrices
vmx_window1 = matrix.load_matrix(mpath.pvmx[f&quot;{floor}{wall_wndo}_window&quot;])
dmx_window1 = matrix.load_matrix(mpath.dmx[f&quot;{wall_wndo}_window&quot;])
tmx_unshaded = matrix.load_matrix(f&quot;Resources/Generic Clear Glass.xml&quot;)
tmx_shaded = matrix.load_matrix(f&quot;Resources/Generic Clear Glass_Satine 5500 5%, White Pearl.xml&quot;)
</code></pre>
<h2 id="define-controller-function-for-cfs-construction-states-and-daylight-dimming">Define controller function for CFS construction states and daylight dimming</h2>
<p>Control fenestration construction based on time; the window is shaded from 11:00 to 15:00; otherwise, unshaded. The nominal lighting power of the light is 30W, controlled with linear daylight dimming based on the workplane illuminance. The workplane illuminance at each timestep is computed by calling <code>matrix.multiply_rgb</code> and pass in the view, trasmission, daylight, and sky matrices. Sky matrix is generated by calling <code>sky.genskymtx</code> and passing in a <code>WeaData</code> and <code>WeaMetaData</code> objects.</p>
<p>Data is accessed through handles, which can be accessed by calling the <code>handles</code> attribute of the <code> EnergyPlusSetup</code> class.  Call <code>get_variable_value</code> and pass in a variable handle to get a variable value (e.g. Direct normal irradiance and diffuse horizontal irradiance). Call <code>actuate</code> and pass in an actuactor handle and value to set the actuator value.</p>
<pre><code class="language-python">def controller(state):
    dni_thld = 800
    nominal_lighting_power = 30

    shade_names = {
        0: &quot;Generic Clear Glass&quot;,
        1: &quot;Generic Clear Glass_Satine 5500 5%, White Pearl&quot;,
    }

    dt = ep.get_datetime()
    direct_normal_irradiance = ep.get_variable_value(
        ep.handles.direct_normal_irradiance
    )
    diffuse_horizontal_irradiance = ep.get_variable_value(
        ep.handles.diffuse_horizontal_irradiance
    )

    ## control CFS construction
    window_handle = ep.handles.window_actuators[&quot;Zn001:Wall001:Win001&quot;]

    # change the fenestration to shaded
    if dt.hour &gt; 10 and dt.hour &lt; 15:
        _shades = 1
        tmx = tmx_shaded
    else:
        _shades = 0
        tmx = tmx_unshaded

    ep.actuate(
        window_handle, ep.handles.complex_fenestration_state[shade_names[_shades]]
    )

    ## control lights
    light_handle = ep.handles.light_actuators[&quot;Light_ZONE ONE&quot;]

    # create WeaData object to create smx
    weadata = types.WeaData(
        time=dt, dni=direct_normal_irradiance, dhi=diffuse_horizontal_irradiance
    )
    # initialize sky/sun matrix
    smx = matrix.load_matrix(sky.genskymtx([weadata], meta, mfactor=4))
    # get workplane illuminance
    wpi = matrix.multiply_rgb(vmx_window1, tmx, dmx_window1, smx, weights=[47.4, 119.9, 11.6])
    avg_wpi = wpi.mean()

    # lighting power, assuming linear dimming curve
    lighting_power = (1 - min(avg_wpi / 500, 1)) * nominal_lighting_power

    ep.actuate(light_handle, lighting_power)
</code></pre>
<h2 id="initialize-pyenergyplusapi-to-simulate">Initialize pyenergyplus.api to simulate</h2>
<p>Register the controller functions to be call back by EnergyPlus by calling <code>set_callback</code> and passing in a callback point and function. To simulate, use <code>run</code> with optional parameters: <code>-w</code> weather file, <code>-d</code> output directory, and <code>-p</code> output prefix (default: eplus).</p>
<p>Refer to <a href="https://energyplus.net/assets/nrel_custom/pdfs/pdfs_v22.1.0/EMSApplicationGuide.pdf">Application Guide for EMS</a> for descriptions of the calling points .</p>
<pre><code>"The calling point called “BeginTimestepBeforePredictor” occurs near the beginning of each timestep
but before the predictor executes. “Predictor” refers to the step in EnergyPlus modeling when the
zone loads are calculated. This calling point is useful for controlling components that affect the
thermal loads the HVAC systems will then attempt to meet. Programs called from this point
might actuate internal gains based on current weather or on the results from the previous timestep.
Demand management routines might use this calling point to reduce lighting or process loads,
change thermostat settings, etc."
</code></pre>
<pre><code class="language-python">with eprad.EnergyPlusSetup(api, epmodel.epjs) as ep:

    # create WeaMetaData object to create smx
    loc = list(epmodel.epjs[&quot;Site:Location&quot;].values())[0]
    meta = types.WeaMetaData(
        city=&quot;&quot;,
        country=&quot;&quot;,
        elevation=loc[&quot;elevation&quot;],
        latitude=loc[&quot;latitude&quot;],
        longitude=0 - loc[&quot;longitude&quot;],
        timezone=(0 - loc[&quot;time_zone&quot;]) * 15,
    )

    ep.set_callback(&quot;callback_begin_system_timestep_before_predictor&quot;, controller)
    ep.run(weather_file=&quot;USA_CA_Oakland.Intl.AP.724930_TMY3.epw&quot;, output_prefix=&quot;1ZoneUncontrolled_win_1&quot;)
</code></pre>
<h2 id="load-and-visualize-results">Load and visualize results</h2>
<p>Use <code>pd.read_csv</code> to read the output csv file.</p>
<pre><code class="language-python">df = pd.read_csv(
    &quot;./1ZoneUncontrolled_win_1out.csv&quot;, index_col=0, parse_dates=True, date_parser=eprad.ep_datetime_parser
)
</code></pre>
<p>Plot data on 07/21</p>
<pre><code class="language-python">df_0721 = df.loc[&quot;1900-07-21&quot;]
</code></pre>
<p>Plot Window Transmitted Solar Radiation Rate. From 11:00 to 15:00, the window is shaded, where the fenestration construction is Generic Clear Glass_Satine 5500 5%, White Pearl. Otherwise, the window is unshaded, where the fenestration construction is Generic Clear Glass. The drop in transmitted solar radiation from 11:00 to 15:00 reflects the change in fenestration state from unshaded to shaded.</p>
<pre><code class="language-python">df_0721[
    &quot;ZN001:WALL001:WIN001:Surface Window Transmitted Solar Radiation Rate [W](TimeStep)&quot;
].plot(ylabel=&quot; Window Transmitted Solar Radiation Rate [W]&quot;)

</code></pre>
<pre><code>&lt;AxesSubplot:xlabel='Date/Time', ylabel=' Window Transmitted Solar Radiation Rate [W]'&gt;
</code></pre>
<p><img alt="png" src="../output_43_1.png" /></p>
<p>Plot lighting electricity rate. The light is linearly dimmed in response to the workplane illuminance. Before the sunrise and after the sunset, the light is in full power. Then, in the morning from 5:30 to 11:00, when the window is unshaded, the lighting power decreases as the workplane illuminance increases; likewise inversely happened in the afternoon from 15:00 until the sunset. From 11:00 to 15:00, the lighting power is higher because the workplane illuminance decreases with the window changed to shaded.</p>
<pre><code class="language-python">df_0721[&quot;LIGHT_ZONE ONE:Lights Electricity Rate [W](TimeStep)&quot;].plot(
    ylabel=&quot;Lights Electricity Rate [W]&quot;
)

</code></pre>
<pre><code>&lt;AxesSubplot:xlabel='Date/Time', ylabel='Lights Electricity Rate [W]'&gt;
</code></pre>
<p><img alt="png" src="../output_45_1.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ba449ae6.min.js"></script>
      
    
  </body>
</html>